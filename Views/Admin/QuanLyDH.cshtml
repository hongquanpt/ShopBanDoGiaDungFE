@{
    ViewBag.Title = "Quản lý đơn hàng";
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
}
<div class="wrapper">

    <!-- Content Wrapper. Contains page content -->
    <div class="content-wrapper">
        <!-- Content Header (Page header) -->
        <!-- Main content -->
        <section class="content">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-12">


                        <div class="card">
                            <div class="card-header">
                                <label class="card-title">Quản lý đơn hàng</label>
                            </div>

                            <ul class="nav nav-tabs" role="tablist">
                                <li class="nav-item"><a class="nav-link active" data-toggle="tab" href="#allOrders">Tất
                                        cả đơn hàng</a></li>
                                <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#pendingOrders">Chờ xác
                                        nhận</a></li>
                                <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#shippingOrders">Đang
                                        vận chuyển</a></li>
                                <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#completedOrders">Đã
                                        hoàn thành</a></li>
                                <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#canceledOrders">Đã
                                        hủy</a></li>
                            </ul>

                            <!-- /.card-header -->
                            <div class="card-body">


                                <!-- Bảng hiển thị đơn hàng -->
                                <div class="tab-content">
                                    <!-- Tất cả đơn hàng -->
                                    <div id="allOrders" class="tab-pane active">
                                        <table id="allOrdersTable" class="table table-bordered table-striped">
                                            <thead>
                                                <tr>
                                                    <th>Mã đơn hàng</th>
                                                    <th>Người nhận</th>
                                                    <th>Địa chỉ giao hàng</th>
                                                    <th>Ngày mua</th>
                                                    <th>Tổng tiền</th>
                                                    <th>Tình trạng</th>
                                                    <th>Chi tiết</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <!-- Dữ liệu sẽ được thêm vào bằng JavaScript -->
                                            </tbody>
                                        </table>
                                    </div>

                                    <!-- Chờ xác nhận -->
                                    <div id="pendingOrders" class="tab-pane fade">
                                        <table id="pendingOrdersTable" class="table table-bordered table-striped">
                                            <thead>
                                                <tr>
                                                    <th>Mã đơn hàng</th>
                                                    <th>Người nhận</th>
                                                    <th>Địa chỉ giao hàng</th>
                                                    <th>Ngày mua</th>
                                                    <th>Tổng tiền</th>
                                                    <th>Tình trạng</th>
                                                    <th>Chi tiết</th>
                                                    <th>Xác nhận</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <!-- Dữ liệu sẽ được thêm vào bằng JavaScript -->
                                            </tbody>
                                        </table>
                                    </div>

                                    <!-- Đang vận chuyển -->
                                    <div id="shippingOrders" class="tab-pane fade">
                                        <table id="shippingOrdersTable" class="table table-bordered table-striped">
                                            <thead>
                                                <tr>
                                                    <th>Mã đơn hàng</th>
                                                    <th>Người nhận</th>
                                                    <th>Địa chỉ giao hàng</th>
                                                    <th>Ngày mua</th>
                                                    <th>Tổng tiền</th>
                                                    <th>Tình trạng</th>
                                                    <th>Chi tiết</th>
                                                    <th>Hoàn thành</th>
                                                    <th>Hủy đơn</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <!-- Dữ liệu sẽ được thêm vào bằng JavaScript -->
                                            </tbody>
                                        </table>
                                    </div>

                                    <!-- Đã hoàn thành -->
                                    <div id="completedOrders" class="tab-pane fade">
                                        <table id="completedOrdersTable" class="table table-bordered table-striped">
                                            <thead>
                                                <tr>
                                                    <th>Mã đơn hàng</th>
                                                    <th>Người nhận</th>
                                                    <th>Địa chỉ giao hàng</th>
                                                    <th>Ngày mua</th>
                                                    <th>Tổng tiền</th>
                                                    <th>Tình trạng</th>
                                                    <th>Chi tiết</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <!-- Dữ liệu sẽ được thêm vào bằng JavaScript -->
                                            </tbody>
                                        </table>
                                    </div>

                                    <!-- Đã hủy -->
                                    <div id="canceledOrders" class="tab-pane fade">
                                        <table id="canceledOrdersTable" class="table table-bordered table-striped">
                                            <thead>
                                                <tr>
                                                    <th>Mã đơn hàng</th>
                                                    <th>Người nhận</th>
                                                    <th>Địa chỉ giao hàng</th>
                                                    <th>Ngày mua</th>
                                                    <th>Tổng tiền</th>
                                                    <th>Tình trạng</th>
                                                    <th>Chi tiết</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <!-- Dữ liệu sẽ được thêm vào bằng JavaScript -->
                                            </tbody>
                                        </table>
                                    </div>

                                </div>

                                <!-- /.card-body -->
                            </div>
                            <!-- /.card-header -->
                            <!-- /.card-body -->
                        </div>
                        <!-- /.card -->
                    </div>

                    <!-- /.col -->
                </div>
                <!-- /.row -->
        </section>
    </div>
</div>

<!-- Modal hiển thị chi tiết đơn hàng -->
<div id="orderDetailModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="orderDetailModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <!-- Nội dung sẽ được thêm vào bằng JavaScript -->
        </div>
    </div>
</div>
<!-- Thêm các thư viện JavaScript cần thiết -->

<script src="~/new/jwt-decode.min.js"></script>

<!-- Bao gồm thư viện jwt-decode -->

<script>
    $(document).ready(function () {
        var token = localStorage.getItem('token');
        if (!token) {
            window.location.href = '/Access/Login';
            return;
        }

        var decodedToken = jwt_decode(token);
        var permissions = decodedToken.permissions || [];
        var canView = permissions.includes("QuanLyDonHang:Xem");
        var canAdd = permissions.includes("QuanLyDonHang:Them");
        var canEdit = permissions.includes("QuanLyDonHang:Sua");
        var canDelete = permissions.includes("QuanLyDonHang:Xoa");

        if (!canView) {
            alert('Bạn không có quyền truy cập trang này.');
            window.location.href = '/';
            return;
        }
        if (!canEdit) {
            $('.confirm-column').hide();
        }
        if (!canAdd) {
            $('.complete-column').hide();
        }
        if (!canDelete) {
            $('.cancel-column').hide();
        }

        $.ajaxSetup({
            beforeSend: function (xhr) {
                xhr.setRequestHeader('Authorization', 'Bearer ' + token);
            }
        });

        //=========================
        // HÀM LOAD ĐƠN HÀNG
        //=========================

        function loadAllOrders(page = 1, pageSize = 1000) {
            $.ajax({
                url: `https://localhost:7248/api/Order/orders?page=${page}&pageSize=${pageSize}`,
                method: 'GET',
                dataType: 'json',
                success: function (data) {
                    populateOrderTable('#allOrdersTable', data.data);
                },
                error: function (error) {
                    console.error('Lỗi khi lấy danh sách đơn hàng:', error);
                }
            });
        }

        function loadOrdersByStatus(status, tableSelector, page = 1, pageSize = 1000) {
            $.ajax({
                url: `https://localhost:7248/api/Order/orders?tinhTrang=${status}&page=${page}&pageSize=${pageSize}`,
                method: 'GET',
                dataType: 'json',
                success: function (data) {
                    populateOrderTable(tableSelector, data.data, status);
                },
                error: function (error) {
                    console.error('Lỗi khi lấy danh sách đơn hàng:', error);
                }
            });
        }

        function populateOrderTable(tableSelector, orders, status) {
            if ($.fn.DataTable.isDataTable(tableSelector)) {
                $(tableSelector).DataTable().clear().destroy();
            }
            var tbody = $(tableSelector + ' tbody');
            tbody.empty();

            orders.forEach(function (order) {
                var tinhTrang = '';
                switch (order.tinhTrang) {
                    case 0: tinhTrang = 'Chưa thanh toán'; break;
                    case 1: tinhTrang = 'Chờ xác nhận';    break;
                    case 2: tinhTrang = 'Đang giao hàng';  break;
                    case 3: tinhTrang = 'Đã hoàn thành';   break;
                    case 4: tinhTrang = 'Đã hủy';          break;
                    default: tinhTrang = 'Không xác định'; break;
                }

                var actionButtons = '<td><button class="btn btn-success view-order-detail" data-id="' + order.maDonHang + '">Chi tiết</button></td>';
                if (status === 1) {
                    // Chờ xác nhận
                    actionButtons += '<td><button class="btn btn-primary confirm-order" data-id="' + order.maDonHang + '">Xác nhận</button></td>';
                } else if (status === 2) {
                    // Đang vận chuyển
                    actionButtons += '<td><button class="btn btn-success complete-order" data-id="' + order.maDonHang + '">Hoàn thành</button></td>';
                    actionButtons += '<td><button class="btn btn-danger cancel-order" data-id="' + order.maDonHang + '">Hủy đơn</button></td>';
                }

                var row = '<tr>' +
                    '<td>' + order.maDonHang + '</td>' +
                    '<td>' + order.nguoiNhan + '</td>' +
                    '<td>' + order.diaChi + '</td>' +
                    '<td>' + new Date(order.ngayMua).toLocaleDateString() + '</td>' +
                    '<td>' + order.tongTien.toLocaleString() + ' VND</td>' +
                    '<td>' + tinhTrang + '</td>' +
                    actionButtons +
                    '</tr>';
                tbody.append(row);
            });

            $(tableSelector).DataTable({
                "paging": true,
                "ordering": true,
                "info": true,
                "searching": true,
                "language": {
                    "paginate": {
                        "next": "Trang sau",
                        "previous": "Trang trước"
                    },
                    "info": "Hiển thị _START_ đến _END_ của _TOTAL_ đơn hàng",
                    "search": "Tìm kiếm:"
                },
                "order": [[0, "desc"]]
            });
        }

        // Gọi load data ban đầu
        loadAllOrders();
        loadOrdersByStatus(1, '#pendingOrdersTable');
        loadOrdersByStatus(2, '#shippingOrdersTable');
        loadOrdersByStatus(3, '#completedOrdersTable');
        loadOrdersByStatus(4, '#canceledOrdersTable');

        // Xử lý chuyển tab
        $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
            var target = $(e.target).attr('href');
            if (target === '#allOrders') {
                loadAllOrders();
            } else if (target === '#pendingOrders') {
                loadOrdersByStatus(1, '#pendingOrdersTable');
            } else if (target === '#shippingOrders') {
                loadOrdersByStatus(2, '#shippingOrdersTable');
            } else if (target === '#completedOrders') {
                loadOrdersByStatus(3, '#completedOrdersTable');
            } else if (target === '#canceledOrders') {
                loadOrdersByStatus(4, '#canceledOrdersTable');
            }
        });

        // Xem chi tiết đơn hàng
        $(document).on('click', '.view-order-detail', function () {
            var orderId = $(this).data('id');
            $.ajax({
                url: `https://localhost:7248/api/Order/orders/${orderId}/details`,
                method: 'GET',
                dataType: 'json',
                success: function (data) {
                    showOrderDetailModal(data);
                },
                error: function (error) {
                    console.error('Lỗi khi lấy chi tiết đơn hàng:', error);
                }
            });
        });

        function showOrderDetailModal(orderDetails) {
            var modalBody = $('#orderDetailModal .modal-content');
            modalBody.empty();

            var content = '<div class="modal-header">' +
                '<h4 class="modal-title">Chi tiết đơn hàng</h4>' +
                '<button type="button" class="close" data-dismiss="modal">&times;</button>' +
                '</div>' +
                '<div class="modal-body">' +
                '<table class="table table-hover">' +
                '<thead>' +
                '<tr>' +
                '<th>Mã SP</th>' +
                '<th>Tên SP</th>' +
                '<th>Ảnh SP</th>' +
                '<th>Số lượng mua</th>' +
                '<th>Đơn giá</th>' +
                '<th>Thành tiền</th>' +
                '</tr>' +
                '</thead>' +
                '<tbody>';

            orderDetails.forEach(function (item) {
                content += '<tr>' +
                    '<td>' + item.maSanPham + '</td>' +
                    '<td><a href="/Product/Detail/' + item.maSanPham + '">' + item.tenSP + '</a></td>' +
                    '<td><img src="' + item.anh + '" class="img-fluid" style="max-width: 100px;"/></td>' +
                    '<td>' + item.soLuong + '</td>' +
                    '<td>' + item.giaBan.toLocaleString() + ' VND</td>' +
                    '<td>' + item.thanhTien.toLocaleString() + ' VND</td>' +
                    '</tr>';
            });

            content += '</tbody></table></div>';
            modalBody.append(content);
            $('#orderDetailModal').modal('show');
        }

        // Xác nhận đơn
        $(document).on('click', '.confirm-order', function () {
            var orderId = $(this).data('id');
            if (confirm('Bạn có chắc chắn muốn xác nhận đơn hàng này?')) {
                $.ajax({
                    url: `https://localhost:7248/api/Order/orders/confirm/${orderId}`,
                    method: 'POST',
                    success: function () {
                       
                        loadOrdersByStatus(1, '#pendingOrdersTable');
                        loadOrdersByStatus(2, '#shippingOrdersTable');
                        loadAllOrders();
                    },
                    error: function (error) {
                        console.error('Lỗi khi xác nhận đơn hàng:', error);
                        alert('Không thể xác nhận đơn hàng');
                    }
                });
            }
        });

        // Hoàn thành đơn
        $(document).on('click', '.complete-order', function () {
            var orderId = $(this).data('id');
            if (confirm('Bạn có chắc chắn muốn hoàn thành đơn hàng này?')) {
                $.ajax({
                    url: `https://localhost:7248/api/Order/orders/ship/${orderId}`,
                    method: 'POST',
                    success: function () {
                       
                        loadOrdersByStatus(2, '#shippingOrdersTable');
                        loadOrdersByStatus(3, '#completedOrdersTable');
                        loadAllOrders();
                    },
                    error: function (error) {
                        console.error('Lỗi khi hoàn thành đơn hàng:', error);
                        alert('Không thể hoàn thành đơn hàng');
                    }
                });
            }
        });

        // Hủy đơn
        $(document).on('click', '.cancel-order', function () {
            var orderId = $(this).data('id');
            if (confirm('Bạn có chắc chắn muốn hủy đơn hàng này?')) {
                $.ajax({
                    url: `https://localhost:7248/api/Order/orders/cancel/${orderId}`,
                    method: 'POST',
                    success: function () {
                        
                        loadOrdersByStatus(2, '#shippingOrdersTable');
                        loadOrdersByStatus(4, '#canceledOrdersTable');
                        loadAllOrders();
                    },
                    error: function (error) {
                        console.error('Lỗi khi hủy đơn hàng:', error);
                        alert('Không thể hủy đơn hàng');
                    }
                });
            }
        });

  
        const orderHubConnection = new signalR.HubConnectionBuilder()
            .withUrl("https://localhost:7248/orderhub", {
                accessTokenFactory: () => token // nếu hub có [Authorize], gửi token
            })
            .build();

        orderHubConnection.start()
            .then(() => {
                console.log("OrderHub connected (Admin)");
                // Gọi RegisterAdmin trên hub
                orderHubConnection.invoke("RegisterAdmin", "admin")
                    .then(() => console.log("Admin joined group 'admin'"))
                    .catch(err => console.error("Error join group:", err));
            })
            .catch(err => console.error("SignalR connection error:", err));

        // Lắng nghe sự kiện "ReceiveNewOrder" => load lại các bảng
        orderHubConnection.on("ReceiveNewOrder", function (newOrder) {
            console.log("Có đơn hàng mới:", newOrder);

            // Gọi hàm loadAllOrders, loadOrdersByStatus để cập nhật
            loadAllOrders();
            loadOrdersByStatus(1, '#pendingOrdersTable');

            // Hoặc tuỳ logic:
            // - Show thông báo popup
            // Swal.fire("Có đơn hàng mới!", `Người nhận: ${newOrder.Ten}`, "info");
        });

    });
</script>
<!-- Các thư viện JavaScript cần thiết -->
<script src="~/Admin/plugins/jquery/jquery.min.js"></script>
<!-- Bootstrap 4 -->
<script src="~/Admin/plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
<!-- DataTables & Plugins -->
<link rel="stylesheet" href="~/Admin/plugins/datatables-bs4/css/dataTables.bootstrap4.min.css">
<link rel="stylesheet" href="~/Admin/plugins/datatables-responsive/css/responsive.bootstrap4.min.css">

<script src="~/Admin/plugins/datatables/jquery.dataTables.min.js"></script>
<script src="~/Admin/plugins/datatables-bs4/js/dataTables.bootstrap4.min.js"></script>
<script src="~/Admin/plugins/datatables-responsive/js/dataTables.responsive.min.js"></script>
<script src="~/Admin/plugins/datatables-responsive/js/responsive.bootstrap4.min.js"></script>
<script src="~/Admin/plugins/datatables-buttons/js/dataTables.buttons.min.js"></script>
<script src="~/Admin/plugins/datatables-buttons/js/buttons.bootstrap4.min.js"></script>
<script src="~/Admin/plugins/jszip/jszip.min.js"></script>
<script src="~/Admin/plugins/pdfmake/pdfmake.min.js"></script>
<script src="~/Admin/plugins/pdfmake/vfs_fonts.js"></script>
<script src="~/Admin/plugins/datatables-buttons/js/buttons.html5.min.js"></script>
<script src="~/Admin/plugins/datatables-buttons/js/buttons.print.min.js"></script>
<script src="~/Admin/plugins/datatables-buttons/js/buttons.colVis.min.js"></script>
<!-- AdminLTE App -->
<script src="~/Admin/dist/js/adminlte.min.js"></script>
